# 3-way handshaking

클라이언트와 서버가 통신을 하기전 정확한 전송을 보장하기 위해 컴퓨터간 세션을 수립하는 과정으로서 TCP 프로토콜에서 신뢰성을 보장하기 위해 사용된다.

## 3-way handshaking이 어떻게 신뢰성을 제공하는가

Handshaking 과정을 설명하자.

## 3-way handshaking

초기 클라이언트 상태는 CLOSE 상태이고 서버의 열려있는 포트의 상태는 LISTEN 상태입니다. 먼저 클라이언트가 서버에게 SYN 신호를 보내면 서버에서는 SYN_RCV 상태로 변경된다. 다시 서버는 클라이언트에게 SYN에 대한 응답으로 ACK를 보내는데 이때 클라이언트의 포트도 열어달라는 SYN을 같이 보낸다. ACK와 SYN를 받은 클라이언트는 ESTABLISHED로 변경되고 응답신호로써 ACK를 서버에게 보낸다. 마지막으로 서버가 ACK 신호를 받으면 ESTABLISHED 상태가 되면서 클라이언트와 서버간 연결이 성공한다.

## 4-way handshaking

클라이언트와 서버가 연결하기 위해 3-way handshaking 과정이 필요하듯이 연결을 종료할때에도 데이터 손실없는 전송을 보장하기 위해 handshaking 과정이 필요한데 이것이 4-way handshaking 이다.

## 4-way handshaking 과정

클라이언트가 종료하겠다는 신호인 FIN을 서버에 보내고 자신은 FIN_WAIT_1 상태로 변경된다. FIN을 받은 서버는 CLOSE_WAIT 상태로 변경되고 응답으로 ACK를 보낸다. ACK를 받은 클라이언트는 다시 FIN_WAIT_2 상태로 변경된다. 이때 서버에 남은 데이터를 모두 전송하고 전송을 다하면 연결을 종료한다는 신호로 FIN을 클라이언트에 보내며 LAST_ACK 상태로 변경된다. FIN을 받은 클라이언트는 TIME_WAIT 상태로 변경되면서 응답으로 ACK를 서버에 보내고, 자신은 일정시간이 지난 후 CLOSE 상태로 변경된다. 마지막으로 응답신호를 받은 서버는 CLOSED 상태로 변경되며 포트를 닫게된다.

## 서버가 마지막에 FIN을 보내는 이유

서버가 아직 클라이언트에 보낼 데이터가 남아있을 경우 데이터를 다 전송하지도 못한채 클라이언트에서 포트를 닫아버리게 되므로 서버 또한 종료될 준비가 되었다는 의미로 FIN을 보내게 된다.

## 클라이언트가 마지막에 ACK를 굳이 보내는 이유

서버가 보낸 FIN 신호를 클라이언트가 받지 못할경우 클라이언트는 FIN_WAIT_2 상태로 종료가 되지 못한채 계속 기다리게 될것이다. 허나 서버는 이미 포트를 닫고 더이상 응답을 안하는 상태이기때문에 클라이언트는 불필요한 자원을 소모하게된다. 